<view class="container">
  <view class="flow-steps">
    <view class="flow-step {{currentStep == 1 ? 'active' : ''}}" bindtap="switchToStep" data-step="1">
      <view class="step-circle">1</view>
      <text class="step-text">研学前</text>
    </view>
    <view class="step-line"></view>
    <view class="flow-step {{currentStep == 2 ? 'active' : ''}} {{!stepsEnabled ? 'disabled' : ''}}" bindtap="switchToStep" data-step="2">
      <view class="step-circle">2</view>
      <text class="step-text">研学中</text>
    </view>
    <view class="step-line"></view>
    <view class="flow-step {{currentStep == 3 ? 'active' : ''}} {{!stepsEnabled ? 'disabled' : ''}}" bindtap="switchToStep" data-step="3">
      <view class="step-circle">3</view>
      <text class="step-text">研学后</text>
    </view>
  </view>

  <!-- 子选项卡，仅在研学前且有建议时显示 -->
  <view class="sub-step-tabs" wx:if="{{currentStep == 1 && showSuggestionsTab}}">
    <view class="sub-step {{subStep == 'info' ? 'active' : ''}}" bindtap="switchSubStep" data-sub-step="info">基本信息</view>
    <view class="sub-step {{subStep == 'suggestions' ? 'active' : ''}}" bindtap="switchSubStep" data-sub-step="suggestions">分析建议</view>
  </view>

  <!-- 研学前-基本信息 -->
  <view class="common-content no-scroll" hidden="{{currentStep != 1 || subStep != 'info'}}">
    <!-- 孩子信息 - 简化版 -->
    <view class="compact-card">
      <view class="mini-header">
        <image class="mini-icon" src="/images/kid_icon.png" mode="aspectFit"></image>
        <text class="mini-title">孩子信息</text>
        <view class="add-icon" bindtap="addKid" wx:if="{{kidsInfo.length < 3}}">+</view>
      </view>

      <view class="compact-kids">
        <block wx:for="{{kidsInfo}}" wx:key="id">
          <view class="kid-row">
            <text class="kid-num">{{item.id}}</text>
            <view class="gender-select">
              <view class="gender-option {{item.gender === '男' ? 'active' : ''}}" bindtap="selectGender" data-index="{{index}}" data-gender="男">男</view>
              <view class="gender-option {{item.gender === '女' ? 'active' : ''}}" bindtap="selectGender" data-index="{{index}}" data-gender="女">女</view>
            </view>
            <input class="mini-input age" type="number" data-index="{{index}}" bindinput="inputAge" value="{{item.age}}" placeholder="年龄"/>
            <text class="delete-icon" bindtap="deleteKid" data-index="{{index}}" wx:if="{{kidsInfo.length > 1}}">×</text>
          </view>
        </block>
      </view>
    </view>

    <!-- 目的地信息 - 简化版 -->
    <view class="compact-card">
      <view class="mini-header">
        <image class="mini-icon" src="/images/location_icon.png" mode="aspectFit"></image>
        <text class="mini-title">目的地</text>
      </view>

      <view class="pick-row">
        <picker class="mini-picker" mode="selector" range="{{['博物馆', '科技馆', '历史遗迹', '自然风光']}}" bindchange="selectVenueType">
          <view class="picker-inner">
            <text class="picker-label">场景:</text>
            <text class="picker-value">{{venueType || '请选择'}}</text>
          </view>
        </picker>

        <picker class="mini-picker" mode="selector" range="{{specificVenueOptions}}" bindchange="selectSpecificVenue">
          <view class="picker-inner">
            <text class="picker-label">场所:</text>
            <text class="picker-value">{{specificVenue || '请选择'}}</text>
          </view>
        </picker>
      </view>
    </view>

    <!-- 时长 - 简化版 -->
    <view class="compact-card">
      <view class="mini-header">
        <image class="mini-icon" src="/images/time_icon.png" mode="aspectFit"></image>
        <text class="mini-title">游览时长</text>
      </view>

      <view class="mini-duration">
        <view class="duration-btn {{duration == '2h' ? 'active' : ''}}" data-time="2h" bindtap="selectDuration">2h</view>
        <view class="duration-btn {{duration == '4h' ? 'active' : ''}}" data-time="4h" bindtap="selectDuration">4h</view>
        <view class="duration-btn {{duration == '半天' ? 'active' : ''}}" data-time="半天" bindtap="selectDuration">半天</view>
        <view class="duration-btn {{duration == '全天' ? 'active' : ''}}" data-time="全天" bindtap="selectDuration">全天</view>
      </view>
    </view>

    <view class="submit-btn" bindtap="generateSuggestion">生成研学分析建议</view>
  </view>
  
  <!-- 研学前-分析建议列表 -->
  <view class="common-content" hidden="{{currentStep != 1 || subStep != 'suggestions'}}">
    <view class="suggestion-tips">
      请选择您感兴趣的研学分析建议（可多选）
      <!-- 在标题右侧添加小型加载指示器，不遮挡内容 -->
      <text class="loading-indicator" wx:if="{{isLoadingMore}}">生成中...</text>
    </view>
    
    <view class="suggestion-list">
      <!-- 只在没有建议时显示初始加载动画 -->
      <view class="loading-container" wx:if="{{suggestions.length === 0 && isLoadingMore}}">
        <view class="spinner"></view>
        <text class="loading-text">正在生成建议...</text>
      </view>
      
      <block wx:for="{{suggestions}}" wx:key="id">
        <view class="suggestion-item {{item.isSelected ? 'selected' : ''}}" 
          bindtap="toggleSelectSuggestion" data-index="{{index}}">
          <view class="suggestion-header">
            <view class="suggestion-title">{{item.title}}</view>
            <view class="suggestion-select-icon">{{item.isSelected ? '✓' : ''}}</view>
          </view>
          <view class="suggestion-brief">{{item.description}}</view>
          <view class="suggestion-footer">
            <view class="suggestion-age">适合年龄: {{item.ageRange}}</view>
            <view class="view-detail" catchtap="viewSuggestionDetail" data-index="{{index}}">查看详情</view>
          </view>
        </view>
      </block>
    </view>

    <!-- 在列表底部添加小型加载指示器，但仅当有建议且仍在加载时 -->
    <view class="bottom-loading-indicator" wx:if="{{suggestions.length > 0 && isLoadingMore}}">
      <text>正在生成更多建议...</text>
      <view class="dot-loading">
        <text class="dot">.</text>
        <text class="dot">.</text>
        <text class="dot">.</text>
      </view>
    </view>

    <view class="primary-btn {{selectedSuggestions.length === 0 ? 'disabled' : ''}}" bindtap="generatePlan">确认选择并开始研学</view>
  </view>
  
  <!-- 研学前-分析建议详情 -->
  <view class="common-content" hidden="{{currentStep != 1 || subStep != 'suggestionDetail'}}">
    <view class="detail-card" wx:if="{{currentSuggestion}}">
      <view class="detail-header">
        <text class="detail-title">{{currentSuggestion.title}}</text>
      </view>
      
      <view class="detail-section">
        <view class="detail-section-title">建议描述</view>
        <view class="detail-desc">{{currentSuggestion.description}}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-section-title">适合年龄段</view>
        <view class="detail-text">{{currentSuggestion.ageRange}}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-section-title">学习目标</view>
        <view class="detail-text">{{currentSuggestion.learningGoals}}</view>
      </view>

      <!-- 添加导读材料板块 -->
      <view class="detail-section" wx:if="{{currentSuggestion.readingMaterials}}">
        <view class="detail-section-title">导读材料</view>
        <view class="detail-text">{{currentSuggestion.readingMaterials}}</view>
      </view>

      <!-- 如果有玩法流程，显示它 -->
      <view class="detail-section" wx:if="{{currentSuggestion.wanfaLiucheng || currentSuggestion.flowProcess}}">
        <view class="detail-section-title">玩法流程</view>
        <view class="detail-text">{{currentSuggestion.wanfaLiucheng || currentSuggestion.flowProcess}}</view>
      </view>
      
      <!-- 如果有高阶思维带动点，显示它 -->
      <view class="detail-section" wx:if="{{currentSuggestion.gaojieThinking || currentSuggestion.advancedThinking}}">
        <view class="detail-section-title">高阶思维带动点</view>
        <view class="detail-text">{{currentSuggestion.gaojieThinking || currentSuggestion.advancedThinking}}</view>
      </view>
    </view>
    
    <view class="buttons-row">
      <view class="secondary-btn half-btn" bindtap="backToSuggestions">返回列表</view>
      <view class="primary-btn half-btn" 
        bindtap="toggleSelectSuggestion" 
        data-index="{{currentSuggestionIndex}}">
        {{currentSuggestion.isSelected ? '取消选择' : '选择此建议'}}
      </view>
    </view>
  </view>
  
  <!-- 研学前-预研学指导故事 -->
  <view class="common-content" hidden="{{currentStep != 1 || subStep != 'guideStory'}}">
    <view class="story-container">
      <view class="section-title">预研学指导故事</view>
      
      <view class="story-card">
        <view class="story-content">
          <view>{{guideStory}}</view>
        </view>
      </view>
      
      <view class="story-desc">阅读后，您将更好地指导孩子进行研学活动</view>
    </view>
    
    <view class="primary-btn" bindtap="startStudyActivity">开始研学活动</view>
  </view>

  <!-- 研学中页面内容 -->
  <view class="common-content" hidden="{{currentStep != 2}}">
    <view class="card">
      <view class="section-title plan-title">{{planTitle}}</view>
      
      <view class="plan-content">
        <block wx:for="{{steps}}" wx:key="id">
          <view class="step-item">
            <view class="step-title">{{item.id}}.{{item.title}}</view>
            <text class="step-desc">{{item.content}}</text>
          </view>
        </block>
      </view>
    </view>
    
    <!-- 研学卡片 -->
    <block wx:if="{{studyCards && studyCards.length > 0}}">
      <view class="card">
        <view class="section-title">研学卡片</view>
        
        <view class="study-cards">
          <block wx:for="{{studyCards}}" wx:key="index">
            <view class="study-card">
              <view class="study-card-title">{{item.title}}</view>
              <text class="study-card-content">{{item.content}}</text>
            </view>
          </block>
        </view>
      </view>
    </block>

    <view class="buttons-row">
      <view class="primary-btn half-btn" bindtap="viewDetails">查看详情</view>
      <view class="primary-btn half-btn" bindtap="completeStudy">完成研学</view>
    </view>
  </view>

  <!-- 研学后页面内容 -->
  <view class="common-content" hidden="{{currentStep != 3}}">
    <view class="card">
      <view class="section-title">研学成果</view>
      
      <view class="image-upload">
        <view class="upload-box" bindtap="chooseImage">
          <image wx:if="{{tempFilePaths.length > 0}}" src="{{tempFilePaths[0]}}" mode="aspectFit" class="preview-image"></image>
          <view wx:else class="upload-icon">+</view>
        </view>
        <text class="upload-text">上传图片</text>
      </view>
      
      <view class="text-area-container">
        <textarea class="reflection-text" placeholder="请输入你的研学心得体会..." bindinput="onTextInput" value="{{reflectionText}}"></textarea>
      </view>
    </view>
    
    <view class="primary-btn" bindtap="shareResults">分享研学成果</view>
  </view>
</view>
