<view class="new-container">
  <!-- é¡¶éƒ¨æµç¨‹æ­¥éª¤ä¿æŒä¸å˜ -->
  <view class="flow-steps">
    <view class="flow-step {{currentStep == 1 ? 'active' : ''}}" bindtap="switchToStep" data-step="1">
      <view class="step-circle">1</view>
      <text class="step-text">ç ”å­¦å‰</text>
    </view>
    <view class="step-line"></view>
    <view class="flow-step {{currentStep == 2 ? 'active' : ''}} {{!stepsEnabled ? 'disabled' : ''}}" bindtap="switchToStep" data-step="2">
      <view class="step-circle">2</view>
      <text class="step-text">ç ”å­¦ä¸­</text>
    </view>
    <view class="step-line"></view>
    <view class="flow-step disabled" bindtap="showInDevelopment" data-step="3">
      <view class="step-circle">3</view>
      <text class="step-text">æ­£åœ¨å¼€å‘.</text>
    </view>
  </view>

  <!-- ç ”å­¦å‰æ–°å¸ƒå±€ -->
  <view class="chat-layout" hidden="{{currentStep != 1}}">
    <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šå¯¹è¯å’Œå»ºè®®å¹¶æ’ -->
    <view class="chat-suggestions-row">
      <!-- å·¦ä¾§å¯¹è¯åŒºåŸŸ -->
      <view class="chat-section">
        <view class="chat-header">
          <text class="chat-title">æ™ºèƒ½åŠ©æ‰‹</text>
          <text class="chat-subtitle">è®©æˆ‘æ¥å¸®æ‚¨è§„åˆ’ç ”å­¦æ´»åŠ¨</text>
        </view>
        
        <view class="chat-messages">
          <block wx:for="{{chatMessages}}" wx:key="id">
            <view class="message {{item.role == 'assistant' ? 'assistant' : 'user'}}">
              <view class="message-avatar">
                <text>{{item.role == 'assistant' ? 'ğŸ¤–' : 'ğŸ‘¤'}}</text>
              </view>
              <view class="message-content">
                <text>{{item.content}}</text>
              </view>
            </view>
          </block>
          
          <!-- AIæ­£åœ¨å›å¤æ—¶çš„å®æ—¶æ˜¾ç¤º -->
          <view class="message assistant" wx:if="{{isAIResponding}}">
            <view class="message-avatar">
              <text>ğŸ¤–</text>
            </view>
            <view class="message-content ai-typing">
              <view class="typing-indicator">
                <view class="typing-dot"></view>
                <view class="typing-dot"></view>
                <view class="typing-dot"></view>
              </view>
            </view>
          </view>
        </view>
        
        <view class="chat-input-area">
          <input class="chat-input" placeholder="è¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚..." value="{{inputText}}" bindinput="onChatInput" confirm-type="send" bindconfirm="sendMessage" disabled="{{isAIResponding}}"/>
          <view class="send-btn {{inputText && !isAIResponding ? 'active' : ''}} {{isAIResponding ? 'disabled' : ''}}" bindtap="sendMessage">
            {{isAIResponding ? 'å›å¤ä¸­...' : 'å‘é€'}}
          </view>
        </view>
        
        <!-- å¼ºåˆ¶å¼€å§‹æŒ‰é’® -->
        <view class="force-start-section" wx:if="{{showForceStartBtn}}">
          <view class="force-start-tip">å¯¹è¯è¾ƒé•¿ï¼Œæ‚¨å¯ä»¥ç›´æ¥å¼€å§‹ç”Ÿæˆå»ºè®®</view>
          <view class="force-start-btn" bindtap="forceStartGeneration">ç›´æ¥å¼€å§‹</view>
        </view>
      </view>

      <!-- å³ä¾§å»ºè®®åŒºåŸŸ -->
      <view class="suggestions-section">
        <view class="suggestions-header">
          <text class="suggestions-title">åˆ†æå»ºè®®</text>
          <text class="suggestions-subtitle">{{suggestions.length > 0 ? 'è¯·é€‰æ‹©æ„Ÿå…´è¶£çš„å»ºè®®' : 'å®Œå–„ä¿¡æ¯åå°†æ˜¾ç¤ºå»ºè®®'}}</text>
        </view>
        
        <view class="suggestions-content">
          <!-- åŠ è½½çŠ¶æ€ -->
          <view class="suggestions-loading" wx:if="{{isLoadingSuggestions}}">
            <view class="spinner"></view>
            <text>æ­£åœ¨ç”Ÿæˆå»ºè®®...</text>
          </view>
          
          <!-- å»ºè®®åˆ—è¡¨ -->
          <view class="suggestions-list" wx:else>
            <block wx:for="{{suggestions}}" wx:key="id">
              <view class="suggestion-card {{item.isSelected ? 'selected' : ''}}" bindtap="toggleSelectSuggestion" data-index="{{index}}">
                <view class="suggestion-header">
                  <view class="suggestion-title">{{item.title}}</view>
                  <view class="suggestion-select-icon">{{item.isSelected ? 'âœ“' : ''}}</view>
                </view>
                <view class="suggestion-brief">{{item.description}}</view>
                <view class="suggestion-footer">
                  <view class="suggestion-age">é€‚åˆ: {{item.ageRange}}</view>
                  <view class="suggestion-actions">
                    <view class="view-detail" catchtap="viewSuggestionDetail" data-index="{{index}}">è¯¦æƒ…</view>
                    <view class="audio-btn" catchtap="togglePlayAudio" data-id="suggestion_{{index}}" data-text="{{item.title}}ã€‚{{item.description}}">
                      <image src="{{isPlayingAudio && currentPlayingId === 'suggestion_'+index ? pauseIconPath : playIconPath}}" mode="aspectFit" class="audio-icon"></image>
                    </view>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
        
        <!-- ç¡®è®¤æŒ‰é’® -->
        <view class="confirm-suggestions">
          <view class="primary-btn {{selectedSuggestions.length === 0 ? 'disabled' : ''}}" bindtap="startGeneration">
            å¼€å§‹ç”Ÿæˆ ({{selectedSuggestions.length}}ä¸ªå»ºè®®)
          </view>
        </view>
      </view>
    </view>

    <!-- ä¸‹åŠéƒ¨åˆ†ï¼šå¹¶å‘ç”ŸæˆåŒºåŸŸ -->
    <view class="generation-section" wx:if="{{showGenerationArea}}">
      <view class="generation-header">
        <text class="generation-title">æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆ</text>
      </view>
      
      <view class="generation-content">
        <!-- å¯¼è¯»ææ–™ç”Ÿæˆ -->
        <view class="generation-item {{guideStoryStatus}} {{guideStory && !storyImageUrl ? 'text-ready' : ''}} {{guideStory && isGeneratingImage ? 'image-loading' : ''}}">
          <view class="generation-item-header">
            <text class="generation-item-title">ğŸ“– å¯¼è¯»ææ–™</text>
            <view class="generation-status">
              <text class="status-text">{{guideStoryStatusText}}</text>
              <view class="status-indicator {{guideStoryStatus}}"></view>
            </view>
          </view>
          <view class="generation-preview {{guideStory ? 'expanded' : ''}}" wx:if="{{guideStory}}">
            <text class="preview-text">{{guideStory.substring(0, 120)}}...</text>
            <text class="preview-desc" wx:if="{{!storyImageUrl && !isGeneratingImage}}">âœ… æ–‡å­—å†…å®¹å·²å®Œæˆ</text>
            <text class="preview-desc" wx:if="{{isGeneratingImage}}">ğŸ¨ æ­£åœ¨ç”Ÿæˆæ’å›¾...</text>
            <text class="preview-desc" wx:if="{{storyImageUrl}}">âœ… æ’å›¾å·²å®Œæˆ</text>
          </view>
        </view>
        
        <!-- ç ”å­¦æ–¹æ¡ˆç”Ÿæˆ -->
        <view class="generation-item {{studyPlanStatus}}">
          <view class="generation-item-header">
            <text class="generation-item-title">ğŸ“‹ ç ”å­¦æ–¹æ¡ˆ</text>
            <view class="generation-status">
              <text class="status-text">{{studyPlanStatusText}}</text>
              <view class="status-indicator {{studyPlanStatus}}"></view>
            </view>
          </view>
          <view class="generation-preview {{planTitle ? 'expanded' : ''}}" wx:if="{{planTitle}}">
            <text class="preview-text">{{planTitle}}</text>
            <text class="preview-desc">åŒ…å«{{steps.length}}ä¸ªæ­¥éª¤ï¼Œ{{studyCards.length}}ä¸ªç ”å­¦å¡ç‰‡</text>
          </view>
        </view>
      </view>
      
      <!-- å®ŒæˆæŒ‰é’® - å¯¼è¯»æ–‡å­—å®Œæˆå°±æ˜¾ç¤º -->
      <view class="generation-actions" wx:if="{{guideStory}}">
        <view class="primary-btn" bindtap="viewStudyPlan">è¿›å…¥ç ”å­¦æµç¨‹</view>
      </view>
    </view>
  </view>

  <!-- å…´è¶£é€‰æ‹©ç•Œé¢ - å…¨æ–°è®¾è®¡ -->
  <view class="interest-selection-modal" hidden="{{!showInterestSelection}}">
    <view class="modal-overlay"></view>
    <view class="interest-modal-content">
      <!-- å¤§ç±»é€‰æ‹©æ­¥éª¤ -->
      <view class="interest-step-content" wx:if="{{currentInterestStep === 'category'}}">
        <view class="interest-header">
          <text class="interest-title">ğŸ¯ é€‰æ‹©å…´è¶£æ–¹å‘</text>
          <text class="interest-subtitle">è¯·é€‰æ‹©æ‚¨å¸Œæœ›é‡ç‚¹åŸ¹å…»å­©å­çš„å…´è¶£é¢†åŸŸï¼ˆå¯å¤šé€‰ï¼‰</text>
        </view>
        
        <view class="interest-categories">
          <block wx:for="{{interestCategories}}" wx:key="id">
            <view class="interest-category-card {{selectedInterestCategories.indexOf(item.id) !== -1 ? 'selected' : ''}}" 
                  bindtap="selectInterestCategory" data-category-id="{{item.id}}">
              <text class="category-icon">{{item.icon}}</text>
              <text class="category-name">{{item.name}}</text>
              <text class="category-count">{{item.subcategories.length}}ä¸ªæ–¹å‘</text>
            </view>
          </block>
        </view>
        
        <view class="interest-actions">
          <view class="secondary-btn" bindtap="skipInterestSelection">è·³è¿‡é€‰æ‹©</view>
          <view class="primary-btn {{selectedInterestCategories.length === 0 ? 'disabled' : ''}}" bindtap="confirmCategorySelection">
            ä¸‹ä¸€æ­¥ ({{selectedInterestCategories.length}})
          </view>
        </view>
      </view>
      
      <!-- ç»†åˆ†é€‰æ‹©æ­¥éª¤ -->
      <view class="interest-step-content" wx:if="{{currentInterestStep === 'subcategory'}}">
        <view class="interest-header">
          <text class="interest-title">ğŸ“š é€‰æ‹©å…·ä½“å…´è¶£</text>
          <text class="interest-subtitle">åœ¨æ‚¨é€‰æ‹©çš„æ–¹å‘ä¸­ï¼Œå…·ä½“åŸ¹å…»å“ªäº›å…´è¶£ï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰</text>
        </view>
        
        <view class="interest-subcategories">
          <block wx:for="{{interestCategories}}" wx:key="id" wx:if="{{selectedInterestCategories.indexOf(item.id) !== -1}}">
            <view class="subcategory-group">
              <view class="subcategory-group-title">
                <text class="group-icon">{{item.icon}}</text>
                <text class="group-name">{{item.name}}</text>
              </view>
              
              <view class="subcategory-items">
                <block wx:for="{{item.subcategories}}" wx:key="id" wx:for-item="sub">
                  <view class="subcategory-card {{selectedSubcategories.indexOf(sub.id) !== -1 ? 'selected' : ''}}"
                        bindtap="selectSubcategory" data-subcategory-id="{{sub.id}}">
                    <view class="subcategory-header">
                      <text class="subcategory-name">{{sub.name}}</text>
                    </view>
                    <text class="subcategory-desc">{{sub.description}}</text>
                  </view>
                </block>
              </view>
            </view>
          </block>
        </view>
        
        <view class="interest-actions">
          <view class="secondary-btn" bindtap="backToCategorySelection">è¿”å›ä¸Šä¸€æ­¥</view>
          <view class="primary-btn {{selectedSubcategories.length === 0 ? 'disabled' : ''}}" bindtap="confirmSubcategorySelection">
            å®Œæˆé€‰æ‹© ({{selectedSubcategories.length}})
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å»ºè®®è¯¦æƒ…å¼¹çª— -->
  <view class="suggestion-detail-modal" hidden="{{!showDetailModal}}">
    <view class="modal-overlay" bindtap="closeDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{currentSuggestion.title}}</text>
        <view class="modal-close" bindtap="closeDetailModal">Ã—</view>
      </view>
      <view class="modal-body">
        <view class="detail-section">
          <view class="detail-section-title">å»ºè®®æè¿°</view>
          <view class="detail-text">{{currentSuggestion.description}}</view>
        </view>
        <view class="detail-section">
          <view class="detail-section-title">é€‚åˆå¹´é¾„</view>
          <view class="detail-text">{{currentSuggestion.ageRange}}</view>
        </view>
        <view class="detail-section">
          <view class="detail-section-title">å­¦ä¹ ç›®æ ‡</view>
          <view class="detail-text">{{currentSuggestion.learningGoals}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç ”å­¦ä¸­é¡µé¢å†…å®¹ä¿æŒåŸæ · -->
  <view class="common-content" hidden="{{currentStep != 2}}">
    <!-- å¯¼è¯»æ•…äº‹åŒºåŸŸ -->
    <view class="card story-card" wx:if="{{guideStory}}">
      <view class="story-header">
        <text class="story-title">å¯¼è¯»æ•…äº‹</text>
        <view class="audio-btn-story" catchtap="togglePlayAudio" data-id="guide_story" data-text="{{guideStory}}">
          <image src="{{isPlayingAudio && currentPlayingId === 'guide_story' ? pauseIconPath : playIconPath}}" mode="aspectFit" class="audio-icon"></image>
        </view>
      </view>
      
      <view class="story-content">
        <text class="story-text">{{guideStory}}</text>
      </view>
      
      <!-- æ•…äº‹æ’å›¾ -->
      <view class="story-image-container" wx:if="{{storyImageUrl || isGeneratingImage || imageError}}">
        <view class="story-image-title">æ•…äº‹æ’å›¾</view>
        
        <!-- åŠ è½½ä¸­çŠ¶æ€ -->
        <view class="image-loading" wx:if="{{isGeneratingImage}}">
          <view class="spinner"></view>
          <text>æ­£åœ¨ç”Ÿæˆæ’å›¾...</text>
          <text class="loading-tips">AIæ­£åœ¨ä¸ºæ‚¨çš„æ•…äº‹åˆ›ä½œä¸“å±æ’å›¾</text>
        </view>
        
        <!-- æ’å›¾æ˜¾ç¤º -->
        <image wx:elif="{{storyImageUrl}}" src="{{storyImageUrl}}" mode="aspectFit" class="story-image" bindtap="previewImage" data-url="{{storyImageUrl}}"></image>
        
        <!-- é”™è¯¯çŠ¶æ€ -->
        <view class="image-error" wx:elif="{{imageError}}">
          <text class="error-text">{{imageError}}</text>
          <view class="retry-btn" bindtap="regenerateImage">é‡æ–°ç”Ÿæˆ</view>
        </view>
      </view>
    </view>
    
    <view class="card">
      <view class="section-title plan-title">{{planTitle}}</view>
      
      <view class="plan-content">
        <block wx:for="{{steps}}" wx:key="id">
          <view class="step-item">
            <view class="step-title">{{item.id}}.{{item.title}}</view>
            <text class="step-desc">{{item.content}}</text>
          </view>
        </block>
      </view>
    </view>
    
    <!-- ç ”å­¦å¡ç‰‡ -->
    <block wx:if="{{studyCards && studyCards.length > 0}}">
      <view class="card">
        <view class="section-title">ç ”å­¦å¡ç‰‡</view>
        
        <view class="study-cards">
          <block wx:for="{{studyCards}}" wx:key="index">
            <view class="study-card" style="border-left-color: {{item.borderColor || '#4caf50'}};">
              <view class="study-card-title">{{item.title}}</view>
              <text class="study-card-content">{{item.content}}</text>
            </view>
          </block>
        </view>
      </view>
    </block>

    <!-- å®Œæˆç ”å­¦æŒ‰é’® - ç­‰å¾…æ‰€æœ‰AIå†…å®¹åŠ è½½å®Œæˆ -->
    <view class="buttons-row" wx:if="{{guideStory && planTitle && studyCards.length > 0}}">
      <view class="primary-btn full-btn" bindtap="completeStudy">å®Œæˆç ”å­¦</view>
    </view>
  </view>

  <!-- ç ”å­¦åé¡µé¢å†…å®¹ä¿æŒåŸæ · -->
  <view class="common-content" hidden="{{currentStep != 3}}">
    <view class="card">
      <view class="section-title">ç ”å­¦æˆæœ</view>
      
      <view class="image-upload">
        <view class="upload-box" bindtap="chooseImage">
          <image wx:if="{{tempFilePaths.length > 0}}" src="{{tempFilePaths[0]}}" mode="aspectFit" class="preview-image"></image>
          <view wx:else class="upload-icon">+</view>
        </view>
        <text class="upload-text">ä¸Šä¼ å›¾ç‰‡</text>
      </view>
      
      <view class="text-area-container">
        <textarea class="reflection-text" placeholder="è¯·è¾“å…¥ä½ çš„ç ”å­¦å¿ƒå¾—ä½“ä¼š..." bindinput="onTextInput" value="{{reflectionText}}"></textarea>
      </view>
    </view>
    
    <view class="primary-btn" bindtap="shareResults">ä¿å­˜åˆ°ç©ºé—´</view>
  </view>
</view>
